name: Create VPS with Direct SSH, Output SSH Info (Automated Parsing)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üìÅ Prepare dirs
        run: mkdir -p links .backup

      - name: ‚úÖ Install OpenSSH & Create User
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo useradd -m vpsuser
          PASSWORD="$(openssl rand -base64 10)"
          echo "vpsuser:$PASSWORD" | sudo chpasswd
          echo "$PASSWORD" > links/ssh_password.txt
          sudo sed -i 's/Port 22/Port 2222/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: üöÄ Start Playit Tunnel for SSH
        run: |
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -O playit
          chmod +x playit
          echo '{"tunnels":[{"proto":"tcp","local_port":2222,"remote_port":0}]}' > playit-config.json
          nohup ./playit --config playit-config.json > playit.log 2>&1 &
          # Tunggu Playit siap dan link muncul di log
          sleep 30
          # Cari link ssh tunnel (format: ssh://user@host:port)
          grep -Eo 'ssh:\/\/[^\"]+' playit.log | head -n 1 > playit_ssh.txt || echo "Playit SSH link not found" > playit_ssh.txt

      - name: üì§ Output SSH Info (Parsing Otomatis)
        run: |
          # Dapatkan link dari playit_ssh.txt
          TUNNEL=$(cat playit_ssh.txt)
          # Parsing host dan port
          HOST=$(echo "$TUNNEL" | awk -F'[@:]' '{print $2}')
          PORT=$(echo "$TUNNEL" | awk -F'[@:]' '{print $3}')
          USER="vpsuser"
          PASS=$(cat links/ssh_password.txt)
          echo "==== SSH LOGIN INFO ====" > links/ssh_info.txt
          echo "Username: $USER" >> links/ssh_info.txt
          echo "Password: $PASS" >> links/ssh_info.txt
          echo "Host: $HOST" >> links/ssh_info.txt
          echo "Port: $PORT" >> links/ssh_info.txt
          cat links/ssh_info.txt

      - name: ‚è≥ Keep VPS alive (POSIX-safe loop)
        run: |
          i=1
          while [ $i -le 360 ]; do
            echo "üü¢ Running minute $i/360..."
            command sleep 60 || break
            i=$((i+1))
          done 
